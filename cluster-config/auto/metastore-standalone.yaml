apiVersion: v1
kind: Service
metadata:
  name: hive-metastore
  namespace: dev
  labels:
    app: metastore-standalone
spec:
  ports:
  - port: 9083
  selector:
    app: metastore-standalone

---

apiVersion: v1
kind: Pod
metadata:
  name: metastore-standalone
  namespace: dev
  labels:
    app: metastore-standalone
spec:
  initContainers:
  - name: download-dependencies
    image: busybox:1.28
    command:
    - /bin/sh
    - -c
    - |
      wget -P /jars https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/3.2.2/hadoop-aws-3.2.2.jar https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/1.11.271/aws-java-sdk-bundle-1.11.271.jar https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.2/postgresql-42.7.2.jar
    volumeMounts:
    - name: jar-volume
      mountPath: /jars
  containers:
  - name: hive-metastore
    image: apache/hive:3.1.3
    resources:
      limits:
        memory: 1G
        cpu: "1"
    env:
    - name: SERVICE_NAME
      value: "metastore"
    - name: AWS_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: minio-access-secret
          key: accessKey

      #value: "eWPnZFJ0aK0WHBEn4DQZ"
    - name: AWS_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: minio-access-secret
          key: secretKey
      #value: "XyzlHA7iL5JihAmzkoar0GP1gwnTemEj9ojMolUK"
    # - name: AWS_ACCESS_KEY_ID
    #   value: YOUR_AWS_ACCESS_KEY
    # - name: AWS_SECRET_ACCESS_KEY
    #   value: YOUR_AWS_SECRET_KEY
    ports:
    - containerPort: 9083
    command: ["/bin/bash", "-c", 
              "cp /jars/* /opt/hadoop/share/hadoop/common &&
              exec /opt/hive/bin/hive --skiphadoopversion --skiphbasecp --service metastore
                --hiveconf javax.jdo.option.ConnectionURL=jdbc:postgresql://dev-postgresql:5432/hivemetastore?createDatabaseIfNotExist=true
                --hiveconf javax.jdo.option.ConnectionDriverName=org.postgresql.Driver
                --hiveconf javax.jdo.option.ConnectionUserName=postgres
                --hiveconf javax.jdo.option.ConnectionPassword=1234
                --hiveconf datanucleus.autoCreateSchema=true
                --hiveconf datanucleus.fixedDatastore=true
                --hiveconf datanucleus.autoCreateTables=true
                --hiveconf fs.s3a.endpoint=http://dev-minio:9000
                --hiveconf fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem
                --hiveconf fs.s3a.aws.credentials.provider=com.amazonaws.auth.EnvironmentVariableCredentialsProvider
                --hiveconf fs.defaultFS=http://dev-minio:9000
                --hiveconf fs.s3a.connection.ssl.enabled=false
                --hiveconf fs.s3a.path.style.access=true"]
                # /opt/hive/bin/schematool -dbType derby -initSchema &&
                # --hiveconf fs.s3a.access.key=ydwyaHzHSZnOsX1qXlNW
                # --hiveconf fs.s3a.secret.key=unFI9HyhLk5PxOzFGl6b2xvfo8k3FfW0QgiZM7uJ
                # cp /jars/* /opt/hive/lib && 
    volumeMounts:
    - name: jar-volume
      mountPath: /jars
  volumes:
  - name: jar-volume
    emptyDir: {}